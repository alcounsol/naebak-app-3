{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - نائبك دوت كوم{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        transition: transform 0.3s ease;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: rotate(45deg);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
    }
    
    .stat-label {
        font-size: 1rem;
        opacity: 0.9;
        position: relative;
        z-index: 2;
    }
    
    .stat-change {
        font-size: 0.8rem;
        margin-top: 5px;
        position: relative;
        z-index: 2;
    }
    
    .stat-change.positive {
        color: #90EE90;
    }
    
    .stat-change.negative {
        color: #FFB6C1;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        height: 400px;
        position: relative;
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .performance-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .performance-table .table {
        margin-bottom: 0;
    }
    
    .performance-table .table thead th {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 15px;
        font-weight: bold;
    }
    
    .performance-table .table tbody td {
        padding: 12px 15px;
        border-color: #f0f0f0;
    }
    
    .performance-table .table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .candidate-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-left: 10px;
    }
    
    .rating-stars {
        color: #ffc107;
    }
    
    .approval-rate {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .approval-high {
        background: #d4edda;
        color: #155724;
    }
    
    .approval-medium {
        background: #fff3cd;
        color: #856404;
    }
    
    .approval-low {
        background: #f8d7da;
        color: #721c24;
    }
    
    .engagement-bar {
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }
    
    .engagement-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .filter-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    
    .export-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .export-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }
    
    .health-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: 8px;
    }
    
    .health-good {
        background: #28a745;
    }
    
    .health-warning {
        background: #ffc107;
    }
    
    .health-critical {
        background: #dc3545;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .trend-indicator {
        font-size: 0.8rem;
        margin-right: 5px;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-stable {
        color: #6c757d;
    }
    
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .quick-stat-item {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-top: 4px solid var(--primary-color);
    }
    
    .quick-stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .quick-stat-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .refresh-timestamp {
        color: #999;
        font-size: 0.8rem;
        text-align: center;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-chart-bar me-2"></i>
                    التقارير والإحصائيات
                </h2>
                <div class="export-buttons">
                    <button class="btn export-btn" onclick="exportReport('candidates')">
                        <i class="fas fa-download me-2"></i>
                        تصدير بيانات المرشحين
                    </button>
                    <button class="btn export-btn" onclick="exportReport('engagement')">
                        <i class="fas fa-download me-2"></i>
                        تصدير بيانات التفاعل
                    </button>
                    <button class="btn export-btn" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>
                        تحديث البيانات
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Time Period Filter -->
    <div class="filter-card">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="fas fa-calendar me-2"></i>
                    فترة التحليل: آخر {{ days }} يوم
                </h5>
                <small class="text-muted">من {{ start_date|date:"d/m/Y" }} إلى {{ end_date|date:"d/m/Y" }}</small>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <a href="?days=7" class="btn {% if days == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">7 أيام</a>
                    <a href="?days=30" class="btn {% if days == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">30 يوم</a>
                    <a href="?days=90" class="btn {% if days == 90 %}btn-primary{% else %}btn-outline-primary{% endif %}">90 يوم</a>
                    <a href="?days=365" class="btn {% if days == 365 %}btn-primary{% else %}btn-outline-primary{% endif %}">سنة</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- General Statistics -->
    <div class="row">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-number">{{ general_stats.total_users }}</div>
                <div class="stat-label">إجمالي المستخدمين</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up trend-indicator trend-up"></i>
                    +{{ engagement_stats.new_users_period }} جديد
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-number">{{ general_stats.total_candidates }}</div>
                <div class="stat-label">إجمالي المرشحين</div>
                <div class="stat-change">
                    <i class="fas fa-users trend-indicator"></i>
                    في {{ general_stats.total_governorates }} محافظة
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-number">{{ engagement_stats.messages_period }}</div>
                <div class="stat-label">الرسائل (الفترة)</div>
                <div class="stat-change">
                    <i class="fas fa-envelope trend-indicator"></i>
                    من {{ general_stats.total_messages }} إجمالي
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-number">{{ engagement_stats.active_users_period }}</div>
                <div class="stat-label">المستخدمون النشطون</div>
                <div class="stat-change">
                    <i class="fas fa-chart-line trend-indicator"></i>
                    {{ engagement_stats.ratings_period }} تقييم
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat-item">
            <div class="quick-stat-number">{{ general_stats.total_promises }}</div>
            <div class="quick-stat-label">الوعود الانتخابية</div>
        </div>
        <div class="quick-stat-item">
            <div class="quick-stat-number">{{ general_stats.published_news }}</div>
            <div class="quick-stat-label">الأخبار المنشورة</div>
        </div>
        <div class="quick-stat-item">
            <div class="quick-stat-number">{{ engagement_stats.votes_period }}</div>
            <div class="quick-stat-label">التصويتات (الفترة)</div>
        </div>
        <div class="quick-stat-item">
            <div class="quick-stat-number">{{ system_health.login_success_rate }}%</div>
            <div class="quick-stat-label">معدل نجاح تسجيل الدخول</div>
        </div>
    </div>
    
    <div class="row">
        <!-- Daily Activity Chart -->
        <div class="col-lg-8">
            <div class="chart-container">
                <div class="chart-title">نشاط المستخدمين اليومي</div>
                <canvas id="dailyActivityChart"></canvas>
                <div class="loading-spinner" id="chartLoading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>جاري تحميل البيانات...</p>
                </div>
            </div>
        </div>
        
        <!-- System Health -->
        <div class="col-lg-4">
            <div class="dashboard-card">
                <h5 class="mb-3">
                    <i class="fas fa-heartbeat me-2"></i>
                    صحة النظام
                </h5>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>الأخطاء الحرجة</span>
                        <span class="badge bg-danger">{{ system_health.error_count }}</span>
                    </div>
                    <div class="health-indicator {% if system_health.error_count == 0 %}health-good{% elif system_health.error_count < 5 %}health-warning{% else %}health-critical{% endif %}"></div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>التحذيرات</span>
                        <span class="badge bg-warning">{{ system_health.warning_count }}</span>
                    </div>
                    <div class="health-indicator {% if system_health.warning_count == 0 %}health-good{% elif system_health.warning_count < 10 %}health-warning{% else %}health-critical{% endif %}"></div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>معدل نجاح تسجيل الدخول</span>
                        <span class="badge bg-success">{{ system_health.login_success_rate }}%</span>
                    </div>
                    <div class="health-indicator {% if system_health.login_success_rate > 95 %}health-good{% elif system_health.login_success_rate > 85 %}health-warning{% else %}health-critical{% endif %}"></div>
                </div>
                <div class="text-center mt-3">
                    <a href="{% url 'naebak:activity_monitoring' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>
                        مراقبة مفصلة
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Performing Candidates -->
    <div class="performance-table">
        <div class="d-flex justify-content-between align-items-center p-3 bg-light">
            <h5 class="mb-0">
                <i class="fas fa-trophy me-2"></i>
                أفضل المرشحين أداءً
            </h5>
            <a href="{% url 'naebak:candidate_performance_report' %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-chart-line me-1"></i>
                تقرير مفصل
            </a>
        </div>
        <table class="table">
            <thead>
                <tr>
                    <th>المرشح</th>
                    <th>المحافظة</th>
                    <th>الرسائل</th>
                    <th>التقييمات</th>
                    <th>متوسط التقييم</th>
                    <th>التصويتات</th>
                    <th>نسبة التأييد</th>
                    <th>نقاط التفاعل</th>
                </tr>
            </thead>
            <tbody>
                {% for item in candidate_stats|slice:":10" %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if item.candidate.profile_image %}
                            <img src="{{ item.candidate.profile_image.url }}" alt="{{ item.candidate.name }}" class="candidate-avatar">
                            {% else %}
                            <div class="candidate-avatar bg-secondary d-flex align-items-center justify-content-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            {% endif %}
                            <div>
                                <div class="fw-bold">{{ item.candidate.name }}</div>
                                <small class="text-muted">{{ item.candidate.electoral_symbol }}</small>
                            </div>
                        </div>
                    </td>
                    <td>{{ item.candidate.governorate.name }}</td>
                    <td>
                        <span class="badge bg-primary">{{ item.total_messages }}</span>
                    </td>
                    <td>
                        <span class="badge bg-info">{{ item.total_ratings }}</span>
                    </td>
                    <td>
                        <div class="rating-stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= item.avg_rating %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="ms-1">{{ item.avg_rating }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-success">{{ item.total_votes }}</span>
                    </td>
                    <td>
                        <span class="approval-rate {% if item.approval_rate >= 70 %}approval-high{% elif item.approval_rate >= 50 %}approval-medium{% else %}approval-low{% endif %}">
                            {{ item.approval_rate }}%
                        </span>
                    </td>
                    <td>
                        <div class="engagement-bar">
                            <div class="engagement-fill" style="width: {% widthratio item.engagement_score 100 100 %}%"></div>
                        </div>
                        <small class="text-muted">{{ item.engagement_score }}</small>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>
                        لا توجد بيانات متاحة
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Governorate Statistics -->
    <div class="row">
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="mb-3">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    إحصائيات المحافظات
                </h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>المحافظة</th>
                                <th>المرشحون</th>
                                <th>النشاط</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in governorate_stats|slice:":8" %}
                            <tr>
                                <td>{{ item.governorate.name }}</td>
                                <td><span class="badge bg-primary">{{ item.candidate_count }}</span></td>
                                <td><span class="badge bg-success">{{ item.activity_score }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="dashboard-card">
                <h5 class="mb-3">
                    <i class="fas fa-newspaper me-2"></i>
                    أفضل المحتوى
                </h5>
                <div class="mb-3">
                    <h6>الأخبار الأكثر مشاهدة:</h6>
                    {% for news in top_news %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-truncate">{{ news.title|truncatechars:40 }}</span>
                        <span class="badge bg-info">{{ news.views_count }} مشاهدة</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">لا توجد أخبار متاحة</p>
                    {% endfor %}
                </div>
                
                <div>
                    <h6>الوعود الأكثر تفاعلاً:</h6>
                    {% for promise in top_promises %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-truncate">{{ promise.title|truncatechars:40 }}</span>
                        <span class="badge bg-success">{{ promise.rating_count }} تقييم</span>
                    </div>
                    {% empty %}
                    <p class="text-muted">لا توجد وعود متاحة</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Links -->
    <div class="text-center mt-4">
        <div class="btn-group" role="group">
            <a href="{% url 'naebak:candidate_performance_report' %}" class="btn btn-outline-primary">
                <i class="fas fa-users me-2"></i>
                تقرير المرشحين
            </a>
            <a href="{% url 'naebak:user_engagement_report' %}" class="btn btn-outline-primary">
                <i class="fas fa-chart-line me-2"></i>
                تقرير التفاعل
            </a>
            <a href="{% url 'naebak:activity_monitoring' %}" class="btn btn-outline-primary">
                <i class="fas fa-eye me-2"></i>
                مراقبة النشاط
            </a>
            <a href="{% url 'naebak:admin_panel' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right me-2"></i>
                العودة للوحة الإدارة
            </a>
        </div>
    </div>
    
    <div class="refresh-timestamp">
        آخر تحديث: {{ end_date|date:"d/m/Y H:i:s" }}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Daily Activity Chart
const ctx = document.getElementById('dailyActivityChart').getContext('2d');
const dailyActivityData = {{ daily_activities|safe }};

const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: dailyActivityData.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
        }),
        datasets: [
            {
                label: 'الرسائل',
                data: dailyActivityData.map(item => item.messages),
                borderColor: 'rgb(46, 125, 50)',
                backgroundColor: 'rgba(46, 125, 50, 0.1)',
                tension: 0.4
            },
            {
                label: 'التقييمات',
                data: dailyActivityData.map(item => item.ratings),
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4
            },
            {
                label: 'التصويتات',
                data: dailyActivityData.map(item => item.votes),
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Export functions
function exportReport(reportType) {
    window.open(`/admin-panel/reports/export/${reportType}/`, '_blank');
}

function refreshDashboard() {
    location.reload();
}

// Auto-refresh every 5 minutes
setInterval(function() {
    refreshDashboard();
}, 300000);

// Animate engagement bars on load
document.addEventListener('DOMContentLoaded', function() {
    const engagementBars = document.querySelectorAll('.engagement-fill');
    engagementBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });
});
</script>
{% endblock %}


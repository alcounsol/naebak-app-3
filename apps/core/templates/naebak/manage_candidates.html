{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .manage-candidates-hero {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 60px 0;
        margin-bottom: 40px;
    }
    
    .search-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 30px;
    }
    
    .candidates-table {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .table th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        color: #495057;
    }
    
    .candidate-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #17a2b8, #138496);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-btn {
        padding: 5px 10px;
        margin: 2px;
        border-radius: 5px;
        font-size: 0.875rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        color: #17a2b8;
    }
    
    .pagination-custom .page-link {
        color: #17a2b8;
        border-color: #17a2b8;
    }
    
    .pagination-custom .page-item.active .page-link {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="manage-candidates-hero">
    <div class="container">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-users-cog me-3"></i>
                    إدارة المرشحين
                </h1>
                <p class="lead">
                    عرض وتعديل وحذف حسابات المرشحين في النظام
                </p>
                <div class="stats-card d-inline-block">
                    <div class="stats-number">{{ total_candidates }}</div>
                    <div>إجمالي المرشحين</div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Search and Filter Section -->
    <div class="search-section">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">البحث</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search_query }}" placeholder="اسم المرشح، اسم المستخدم، البريد الإلكتروني...">
            </div>
            
            <div class="col-md-3">
                <label for="governorate" class="form-label">المحافظة</label>
                <select class="form-control" id="governorate" name="governorate">
                    <option value="">جميع المحافظات</option>
                    {% for gov in governorates %}
                        <option value="{{ gov.id }}" {% if governorate_filter == gov.id|stringformat:"s" %}selected{% endif %}>
                            {{ gov.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-info me-2">
                    <i class="fas fa-search me-1"></i>بحث
                </button>
                <a href="{% url 'naebak:manage_candidates' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>مسح
                </a>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
                <a href="{% url 'naebak:create_candidate' %}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>مرشح جديد
                </a>
            </div>
        </form>
    </div>
    
    <!-- Candidates Table -->
    <div class="candidates-table">
        {% if candidates %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>المرشح</th>
                            <th>معلومات الحساب</th>
                            <th>المحافظة والدائرة</th>
                            <th>الإحصائيات</th>
                            <th>تاريخ الإنشاء</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="candidate-avatar me-3">
                                            {{ candidate.name|first }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ candidate.name }}</div>
                                            <small class="text-muted">{{ candidate.role }}</small>
                                        </div>
                                    </div>
                                </td>
                                
                                <td>
                                    <div>
                                        <strong>{{ candidate.user.username }}</strong>
                                    </div>
                                    <small class="text-muted">{{ candidate.user.email }}</small>
                                    <br>
                                    <span class="status-badge {% if candidate.user.is_active %}status-active{% else %}status-inactive{% endif %}">
                                        {% if candidate.user.is_active %}نشط{% else %}غير نشط{% endif %}
                                    </span>
                                </td>
                                
                                <td>
                                    {% if candidate.governorate %}
                                        <div><strong>{{ candidate.governorate.name }}</strong></div>
                                        {% if candidate.constituency %}
                                            <small class="text-muted">{{ candidate.constituency }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">غير محدد</span>
                                    {% endif %}
                                    {% if candidate.election_number %}
                                        <br><small class="badge bg-secondary">رقم: {{ candidate.election_number }}</small>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="small">
                                        <div><i class="fas fa-envelope text-primary"></i> {{ candidate.total_messages }} رسالة</div>
                                        <div><i class="fas fa-star text-warning"></i> {{ candidate.total_ratings }} تقييم</div>
                                        <div><i class="fas fa-vote-yea text-success"></i> {{ candidate.total_votes }} صوت</div>
                                        {% if candidate.avg_rating > 0 %}
                                            <div><i class="fas fa-chart-line text-info"></i> {{ candidate.avg_rating|floatformat:1 }}/5</div>
                                        {% endif %}
                                    </div>
                                </td>
                                
                                <td>
                                    <div>{{ candidate.created_at|date:"Y/m/d" }}</div>
                                    <small class="text-muted">{{ candidate.created_at|date:"H:i" }}</small>
                                </td>
                                
                                <td>
                                    <div class="btn-group-vertical" role="group">
                                        <a href="{% url 'naebak:candidate_detail' candidate.id %}" 
                                           class="btn btn-sm btn-outline-info action-btn" title="عرض الملف الشخصي">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-warning action-btn" 
                                                title="تعديل" onclick="editCandidate({{ candidate.id }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger action-btn" 
                                                title="حذف" onclick="deleteCandidate({{ candidate.id }}, '{{ candidate.name }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if candidates.has_other_pages %}
                <div class="d-flex justify-content-center p-4">
                    <nav aria-label="صفحات المرشحين">
                        <ul class="pagination pagination-custom">
                            {% if candidates.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ candidates.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if governorate_filter %}&governorate={{ governorate_filter }}{% endif %}">
                                        السابق
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for num in candidates.paginator.page_range %}
                                {% if candidates.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if governorate_filter %}&governorate={{ governorate_filter }}{% endif %}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if candidates.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ candidates.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if governorate_filter %}&governorate={{ governorate_filter }}{% endif %}">
                                        التالي
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center p-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">لا توجد مرشحين</h4>
                <p class="text-muted">لم يتم العثور على أي مرشحين مطابقين لمعايير البحث</p>
                <a href="{% url 'naebak:create_candidate' %}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>إنشاء مرشح جديد
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">تأكيد الحذف</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>هل أنت متأكد من حذف المرشح <strong id="candidateName"></strong>؟</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    سيتم حذف جميع البيانات المرتبطة بهذا المرشح نهائياً ولا يمكن التراجع عن هذا الإجراء.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">حذف نهائياً</button>
            </div>
        </div>
    </div>
</div>

<script>
let candidateToDelete = null;

function deleteCandidate(candidateId, candidateName) {
    candidateToDelete = candidateId;
    document.getElementById('candidateName').textContent = candidateName;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (candidateToDelete) {
        fetch(`/admin-panel/delete-candidate/${candidateToDelete}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('حدث خطأ: ' + data.error);
            }
        })
        .catch(error => {
            alert('حدث خطأ في الاتصال');
        });
        
        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
    }
});

function editCandidate(candidateId) {
    // TODO: Implement edit functionality
    alert('سيتم إضافة وظيفة التعديل قريباً');
}
</script>
{% endblock %}

